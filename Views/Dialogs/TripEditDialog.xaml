<Window x:Class="BusParkManagementSystem.Views.Dialogs.TripEditDialog"
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:converters="clr-namespace:BusParkManagementSystem.Converters"
        Title="{Binding WindowTitle}" 
        Height="650" 
        Width="600"
        WindowStartupLocation="CenterOwner"
        ResizeMode="NoResize"
        Background="#F5F5F5"
        MinHeight="500"
        MinWidth="550">

    <Window.Resources>
        <BooleanToVisibilityConverter x:Key="BoolToVis"/>
        <converters:DecimalConverter x:Key="DecimalConverter"/>

        <Style TargetType="TextBlock">
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="FontWeight" Value="SemiBold"/>
        </Style>

        <Style TargetType="ComboBox">
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="Height" Value="30"/>
        </Style>

        <Style TargetType="TextBox">
            <Setter Property="VerticalContentAlignment" Value="Center"/>
            <Setter Property="Height" Value="30"/>
        </Style>

        <Style TargetType="DatePicker">
            <Setter Property="Height" Value="30"/>
        </Style>
    </Window.Resources>

    <ScrollViewer VerticalScrollBarVisibility="Auto" Padding="5">
        <Grid>
            <Grid.RowDefinitions>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="*"/>
                <RowDefinition Height="Auto"/>
                <RowDefinition Height="Auto"/>
            </Grid.RowDefinitions>

            <!-- Заголовок -->
            <Border Grid.Row="0" Background="#2C3E50" CornerRadius="3" Margin="0,0,0,15">
                <TextBlock Text="{Binding WindowTitle}" 
                           FontSize="20" 
                           FontWeight="Bold"
                           Foreground="White"
                           HorizontalAlignment="Center"
                           Padding="10"/>
            </Border>

            <!-- Форма редактирования -->
            <Border Grid.Row="1" 
                    BorderBrush="#BDBDBD" 
                    BorderThickness="1" 
                    CornerRadius="5"
                    Background="White"
                    Padding="15">
                <Grid>
                    <Grid.RowDefinitions>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                        <RowDefinition Height="Auto"/>
                    </Grid.RowDefinitions>

                    <Grid.ColumnDefinitions>
                        <ColumnDefinition Width="Auto" MinWidth="120"/>
                        <ColumnDefinition Width="*"/>
                    </Grid.ColumnDefinitions>

                    <!-- Маршрут -->
                    <TextBlock Grid.Row="0" Grid.Column="0" Text="Маршрут*:" Margin="0,0,10,10"/>
                    <ComboBox Grid.Row="0" Grid.Column="1" 
                              ItemsSource="{Binding Routes}"
                              SelectedValuePath="Id"
                              SelectedValue="{Binding Trip.RouteId, UpdateSourceTrigger=PropertyChanged}"
                              DisplayMemberPath="DisplayName"
                              Margin="0,0,0,10"
                              IsEditable="False"/>

                    <!-- Автобус -->
                    <TextBlock Grid.Row="1" Grid.Column="0" Text="Автобус*:" Margin="0,0,10,10"/>
                    <ComboBox Grid.Row="1" Grid.Column="1" 
                              ItemsSource="{Binding Buses}"
                              SelectedValuePath="Id"
                              SelectedValue="{Binding Trip.BusId, UpdateSourceTrigger=PropertyChanged}"
                              DisplayMemberPath="DisplayName"
                              Margin="0,0,0,10"
                              IsEditable="False"/>

                    <!-- Водитель -->
                    <TextBlock Grid.Row="2" Grid.Column="0" Text="Водитель*:" Margin="0,0,10,10"/>
                    <ComboBox Grid.Row="2" Grid.Column="1" 
                              ItemsSource="{Binding Drivers}"
                              SelectedValuePath="Id"
                              SelectedValue="{Binding Trip.DriverId, UpdateSourceTrigger=PropertyChanged}"
                              DisplayMemberPath="DisplayName"
                              Margin="0,0,0,10"
                              IsEditable="False"/>

                    <!-- Кондуктор -->
                    <TextBlock Grid.Row="3" Grid.Column="0" Text="Кондуктор*:" Margin="0,0,10,10"/>
                    <ComboBox Grid.Row="3" Grid.Column="1" 
                              ItemsSource="{Binding Conductors}"
                              SelectedValuePath="Id"
                              SelectedValue="{Binding Trip.ConductorId, UpdateSourceTrigger=PropertyChanged}"
                              DisplayMemberPath="DisplayName"
                              Margin="0,0,0,10"
                              IsEditable="False"/>

                    <!-- Дата рейса -->
                    <TextBlock Grid.Row="4" Grid.Column="0" Text="Дата рейса*:" Margin="0,0,10,10"/>
                    <DatePicker Grid.Row="4" Grid.Column="1" 
                                SelectedDate="{Binding Trip.TripDate, UpdateSourceTrigger=PropertyChanged}"
                                Margin="0,0,0,10"/>

                    <!-- Тип смены -->
                    <TextBlock Grid.Row="5" Grid.Column="0" Text="Тип смены*:" Margin="0,0,10,10"/>
                    <ComboBox Grid.Row="5" Grid.Column="1" 
                              ItemsSource="{Binding ShiftTypes}"
                              SelectedValuePath="Id"
                              SelectedValue="{Binding Trip.ShiftTypeId, UpdateSourceTrigger=PropertyChanged}"
                              DisplayMemberPath="ShiftName"
                              Margin="0,0,0,10"
                              IsEditable="False"/>

                    <!-- Плановая выручка -->
                    <TextBlock Grid.Row="6" Grid.Column="0" Text="План. выручка*:" Margin="0,0,10,10"/>
                    <TextBox Grid.Row="6" Grid.Column="1" 
                             Text="{Binding Trip.PlannedRevenue, UpdateSourceTrigger=PropertyChanged, 
                                    Converter={StaticResource DecimalConverter}}"
                             Margin="0,0,0,10"
                             ToolTip="Введите положительное число (например: 15000.50)"/>

                    <!-- Статус -->
                    <TextBlock Grid.Row="7" Grid.Column="0" Text="Статус*:" Margin="0,0,10,10"/>
                    <ComboBox Grid.Row="7" Grid.Column="1" 
                              ItemsSource="{Binding Statuses}"
                              SelectedItem="{Binding Trip.Status, UpdateSourceTrigger=PropertyChanged}"
                              Margin="0,0,0,10"
                              IsEditable="False"/>

                    <!-- Причина снятия (если статус "отменен") -->
                    <TextBlock Grid.Row="8" Grid.Column="0" Text="Причина снятия:" 
                               Margin="0,0,10,10">
                        <TextBlock.Style>
                            <Style TargetType="TextBlock">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding Trip.Status}" Value="отменен">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </TextBlock.Style>
                    </TextBlock>
                    <TextBox Grid.Row="8" Grid.Column="1" 
                             Text="{Binding Trip.CancellationReason, UpdateSourceTrigger=PropertyChanged}"
                             Margin="0,0,0,10"
                             AcceptsReturn="True"
                             TextWrapping="Wrap"
                             MinHeight="60"
                             VerticalScrollBarVisibility="Auto">
                        <TextBox.Style>
                            <Style TargetType="TextBox">
                                <Setter Property="Visibility" Value="Collapsed"/>
                                <Style.Triggers>
                                    <DataTrigger Binding="{Binding Trip.Status}" Value="отменен">
                                        <Setter Property="Visibility" Value="Visible"/>
                                    </DataTrigger>
                                </Style.Triggers>
                            </Style>
                        </TextBox.Style>
                    </TextBox>
                </Grid>
            </Border>

            <!-- Панель ошибок -->
            <Border Grid.Row="2" 
                    Background="#FFF2DEDE" 
                    BorderBrush="#E6B3B3" 
                    BorderThickness="1"
                    CornerRadius="5"
                    Padding="10,8"
                    Margin="0,10,0,10"
                    Visibility="{Binding HasErrors, Converter={StaticResource BoolToVis}}">
                <StackPanel>
                    <TextBlock Text="⚠️ Ошибки валидации:" 
                               FontWeight="Bold" 
                               Foreground="#A94442"
                               Margin="0,0,0,5"/>
                    <ItemsControl ItemsSource="{Binding Errors}">
                        <ItemsControl.ItemTemplate>
                            <DataTemplate>
                                <TextBlock Text="{Binding}" 
                                           TextWrapping="Wrap"
                                           Foreground="#A94442"
                                           Margin="5,2,0,2"/>
                            </DataTemplate>
                        </ItemsControl.ItemTemplate>
                    </ItemsControl>
                </StackPanel>
            </Border>

            <!-- Кнопки -->
            <Border Grid.Row="3" 
                    BorderBrush="#E0E0E0" 
                    BorderThickness="0,1,0,0"
                    Background="#F8F8F8"
                    Padding="10">
                <StackPanel Orientation="Horizontal" HorizontalAlignment="Right">
                    <Button Content="Отмена" 
                            Width="120" 
                            Height="35"
                            Margin="0,0,10,0"
                            Command="{Binding CancelCommand}"
                            Background="#F5F5F5"
                            BorderBrush="#CCCCCC"
                            Foreground="#333333"/>

                    <Button Content="Сохранить" 
                            Width="120" 
                            Height="35"
                            Command="{Binding SaveCommand}"
                            IsEnabled="{Binding CanSave}"
                            Background="#4CAF50"
                            Foreground="White"
                            FontWeight="Bold"/>
                </StackPanel>
            </Border>
        </Grid>
    </ScrollViewer>
</Window>